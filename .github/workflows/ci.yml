name: CI

on:
  push:
    branches: [main]
  pull_request:

permissions:
  contents: read
  checks: write
  pull-requests: write

jobs:
  lint-and-typecheck:
    name: lint-and-typecheck
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
    runs-on: ${{ matrix.os }}
    steps:
      - uses: actions/checkout@v6
      - uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest
      - uses: actions/cache@v5
        id: cache
        with:
          path: ~/.bun/install/cache
          key: ${{ runner.os }}-${{ matrix.os }}-bun-latest-${{ hashFiles('**/bun.lock') }}
          restore-keys: |
            ${{ runner.os }}-${{ matrix.os }}-bun-latest-
      - run: bun install --frozen-lockfile --linker=isolated
      - run: bun run lint
      - run: bun run typecheck

  electrobun-build-smoke:
    name: electrobun-build-smoke-${{ matrix.os }}
    strategy:
      matrix:
        include:
          - os: ubuntu-latest
            platform: linux
          - os: macos-latest
            platform: macos
          - os: windows-latest
            platform: win
    runs-on: ${{ matrix.os }}
    steps:
      - uses: actions/checkout@v6
      - uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest
      - uses: actions/cache@v5
        id: cache
        with:
          path: ~/.bun/install/cache
          key: ${{ runner.os }}-${{ matrix.os }}-bun-latest-${{ hashFiles('**/bun.lock') }}
          restore-keys: |
            ${{ runner.os }}-${{ matrix.os }}-bun-latest-
      - run: bun install --frozen-lockfile --linker=isolated
      - name: Build host CLI binary
        shell: bash
        run: |
          mkdir -p dist
          OUT="dist/council-test"
          if [[ "${{ matrix.platform }}" == "win" ]]; then
            OUT="${OUT}.exe"
          fi
          bun build src/cli/index.ts --compile --minify --outfile="$OUT"
          echo "CLI_OUT=$OUT" >> "$GITHUB_ENV"
      - name: Smoke-test CLI binary
        shell: bash
        run: |
          if [[ "${{ matrix.platform }}" != "win" ]]; then
            chmod +x "$CLI_OUT"
          fi
          "./$CLI_OUT" --version
          "./$CLI_OUT" --help
      - name: Build Electrobun stable artifacts
        shell: bash
        env:
          AGENTS_COUNCIL_VERSION: "ci-smoke"
        run: |
          bunx electrobun build --env=stable
      - name: Validate Electrobun artifact set
        shell: bash
        run: |
          set -euo pipefail
          ls -la artifacts
          PREFIX="stable-${{ matrix.platform }}-"
          ALL_COUNT=$(find artifacts -maxdepth 1 -type f -name "${PREFIX}*" | wc -l | tr -d ' ')
          if [[ "$ALL_COUNT" -eq 0 ]]; then
            echo "No Electrobun artifacts found for prefix: ${PREFIX}"
            exit 1
          fi
          UPDATE_COUNT=$(find artifacts -maxdepth 1 -type f -name "${PREFIX}*update.json" | wc -l | tr -d ' ')
          if [[ "$UPDATE_COUNT" -eq 0 ]]; then
            echo "Missing update metadata for ${PREFIX}"
            exit 1
          fi
          BUNDLE_COUNT=$(find artifacts -maxdepth 1 -type f -name "${PREFIX}*.tar.zst" | wc -l | tr -d ' ')
          if [[ "$BUNDLE_COUNT" -eq 0 ]]; then
            echo "Missing compressed desktop bundle for ${PREFIX}"
            exit 1
          fi
          case "${{ matrix.platform }}" in
            macos)
              INSTALLER_COUNT=$(find artifacts -maxdepth 1 -type f -name "${PREFIX}*.dmg" | wc -l | tr -d ' ')
              ;;
            linux)
              INSTALLER_COUNT=$(find artifacts -maxdepth 1 -type f -name "${PREFIX}*Setup*.tar.gz" | wc -l | tr -d ' ')
              ;;
            win)
              INSTALLER_COUNT=$(find artifacts -maxdepth 1 -type f -name "${PREFIX}*Setup*.zip" | wc -l | tr -d ' ')
              ;;
            *)
              echo "Unsupported platform: ${{ matrix.platform }}"
              exit 1
              ;;
          esac
          if [[ "$INSTALLER_COUNT" -eq 0 ]]; then
            echo "Missing desktop installer artifact for ${PREFIX}"
            exit 1
          fi
